\chapter{Identification}
\section{Sputnik VAD}\label{Sputnik}
% graphic of Sputnik construction
The Sputnik VAD is an axial-flow blood pump, developed in a cooperative project of the National Research University of Electronic Technology, OJSC Zelenograd Innovation-Technology Center of Medical Equipment, FSBI "Academician V.I. Shumakov Federal Research Center of Transplantology and Artificial Organs", Ministry of Health of Russian Federation, DONA-M LLC and BIOSOFT-M LLC in 2009. \cite{Sputnik1}
\\This device is used for left ventricular assistance in patients with acute heart failure. The therapeutic objective in implantation of a Sputnik VAD is bridging to transplantation. The VAD is able to pump up to 10 liters of blood per minute with a continuous flow profile. The implantable pump weighs about $200\, g$, has a length of $81\, mm$ and a maximum diameter of $34\, mm$. It consists of a moving and a stationary part. The moving part, the impeller, a rotor with four blades, contains a permanent NdFeB-magnet, which is actuated by a brushless DC motor. The rotor spins clockwise with speed values between $4000-10000\, rpm$. An overview of the pump's specification is presented in \tablename~ \ref{tab:sput1}.
\begin{table}[ht]
  \centering
  \begin{tabular}{c|c}
    \toprule
    Blood flow  & 0-10 l/min \\
    Rotational speed & 4000-10000 rpm \\
    Length & 81 mm \\
    Diameter & 34 mm \\
    Weight & 200 g \\
    \bottomrule
\end{tabular}
  \caption[Specifications of Sputnik VAD]{Specifications of Sputnik VAD}
  \label{tab:sput1}
\end{table}
\\The stator is located inside a titanium housing with a diameter of $16\, mm$. The stationary part of the pump consists of a flow straightener with three stationary blades and a flow diffusor with three twisted blades. The flow straightener is located in front of the rotor and straightens the incoming blood flow into the rotor. Behind the rotor, blood is directed into the diffusor. %\cite{Sputnik1}
\figurename~ \ref{fig:sput_cross} depicts a cross-section of the Sputnik VAD and identifies its individual components.
The connection between the pump and the cardiovascular system is performed using in- and outflow cannulas, a felt ferule and vascular prosthesis which is sewed to the aorta. \cite{Sputnik1}
\begin{figure}[ht]
  \centering
  \includegraphics[width=0.6\textwidth]{images/chapt_4/sputnik_cross.png}
  \caption[Cross-section of Sputnik VAD \cite{Sputnik6}]{Cross-section of the Sputnik VAD \cite{Sputnik6}.}
  \label{fig:sput_cross}
\end{figure}
\\The Sputnik VAD is powered using two lithium-ion batteries, fully charged providing enough energy for up to eight hours of system support. The maximum charging time for the batteries is less than five hours. During this time the batteries can either be exchanged by another set of batteries or the system can be powered through connection to an AC network. A microprocessor-based driving unit is used to regulate the pump speed, manage the power supply and store parameter data. It is connected percutaneously to the pump with an up to $170\, cm$ long and $5\, cm$ wide lead. \cite{Sputnik1}
\\During the practical part of this work, the pump was controlled using the servo controller module ESCON 50/4 EC-S from maxon motor. This is a 4-quadrant pulse width modulation controller for controlling motors without Hall sensors.
%%%% ANSTEUERUNG ÜBER ESCON ERKLÄREN!!!

\section{Hardware in the Loop Test Bench}
For all measurements and tests performed during this thesis, a hardware in the loop (HiL) test bench of the Chair of Medical Information Technology at RWTH Aachen University is used. The test bench is set up as a feedback controlled human circulatory system simulator. With the aid of the test rig, it is possible to test MCS systems under various physiological and pathological conditions of the cardiovascular system.
\begin{figure}[ht]
  \centering
  \includegraphics[width=\textwidth]{images/chapt_4/mock_loop.jpg}
  \caption[HiL test bench]{Structure of the HiL human circulatory system simulator based on \cite{MCL}.}
  \label{fig:mock_loop}
\end{figure}
\\The structure of the mock circulatory loop (MCL) is depicted in \figurename~\ref{fig:mock_loop}. The boxes marked $V_{\mathrm{1}}$ and $V_{\mathrm{2}}$ are pressure compartments simulating the volume of the left ventricle and the aorta, respectively. Therefore, the pressure values of these compartments, referred to as $p_{\mathrm{1}}$ and $p_{\mathrm{2}}$, can be physiologically compared to the pressure values of the left ventricle and aorta. The MCL is actuated by three gear pumps ($GP_{\mathrm{1}}$, $GP_{\mathrm{12}}$ and $GP_{\mathrm{2}}$) and two voice coil actuators ($VCA_{\mathrm{1}}$ and $VCA_{\mathrm{2}}$). The Sputnik VAD is connected to the pressure chambers in parallel, enabling tests similar to real use cases. This way, the VAD can be subjected to comparable pressure changes in the differential pressure between the aorta and ventricle as would be the case when used on the beating heart.
\\By controlling the MCL through a dSpace system (DS1103), pressure in the chambers can be adjusted in real time to simulate different cardiac dysfunctions. The dSpace system furthermore enables recording of reference signals presented to the MCL, as well as real time measurements.
\\As the Sputnik VAD is not usually included into the MCL setup, flow through the device can not be measured without further equipment. For this purpose the Transonic Systems Inc. T110 flowmeter is included in the setup. The flow sensor measurement is based on ultrasonic technology. The sensor probe, as presented in \figurename~\ref{fig:flow_meter_tube}, is mounted onto the tube leading from the pressure chamber representing the left ventricle to the VAD. The flowmeter too is connected to the dSpace system, enabling recording of the measured flow values. In \figurename~\ref{fig:mock_loop} the measurement of the device is represented by $\dot{V}_{\mathrm{DUT}}$.
\begin{figure}[ht]
  \centering
  \includegraphics[width=0.8\textwidth]{images/chapt_4/flow_meter.pdf}
  \caption[Sputnik VAD and flowmeter in HiL setup]{Sputnik VAD and flowmeter in HiL setup.}
  \label{fig:flow_meter_tube}
\end{figure}
\\The ESCON servo controller mentioned in chapter \ref{Sputnik}, as well as the flowmeter and the MCL, is connected to the dSpace system. Using the digital input port of the controller, a set value for regulation of the rotational speed can be transferred to the controller after defining the value in the system.
\\The dSpace system itself is controlled with the use of the program ControlDesk. This software provides the opportunity to include Matlab and Simulink source code. By this, controllers designed with the use of Simulink can directly be tested at the HiL test bench. It furthermore enables exporting all measured data in form of Matlab matrices.

\section{System Identification}
For the implementation of flow control algorithms for the Sputnik VAD, knowledge of the system behavior is required. In order to gain this information, various tests have been performed to determine a static map for the system. For this purpose, a multiple-input-single-output (MISO) system with input variables differential pressure $\Delta{p}$ in $mmHg$, rotational speed $v$ in $rpm$ and output variable blood flow $q$ in $l/min$ is assumed. The differential pressure is defined as
\begin{equation}
  \Delta{p} = p_{\mathrm{ao}} - p_{\mathrm{lv}} = p_{\mathrm{2}} - p_{\mathrm{1}},
\end{equation}
with $p_{\mathrm{ao}}$ depicting the pressure of the aorta and $p_{\mathrm{lv}}$ corresponding to the left ventricular pressure.
\\Using the HiL test rig, the differential pressure is increased in steps of $20\, mmHg$ starting at $0\,mmHg$ and ending at $140\,mmHg$. For each differential pressure step, the reference speed of the pump is increased from $4000\, rpm$ in steps of $1000\, rpm$ to $9000\, rpm$. Flow for each reference speed is measured for $5\, s$. In order to eliminate inaccuracies due to transient processes, solely the last quarter of each mesurement stage is considered for the evaluation using Matlab. \figurename~\ref{fig:test_60w40g_long} depicts the signal curves for the measurement described above. The upper graph shows the course of the reference differential pressure ($\Delta{p_{\mathrm{ref}}}$) and the differential pressure measured at the HiL test stand ($\Delta{p_{\mathrm{HiL}}}$).
In the middle, the curves of the reference velocity ($v_{\mathrm{ref}}$) and the measured velocity of the Sputnik VAD ($v_{\mathrm{vad}}$) are shown. The lower graph shows the resulting flow through the blood pump ($q_{\mathrm{vad}}$).


\begin{figure}[ht]
  \centering
  \includegraphics[width=\textwidth]{images/chapt_4/Test_60w40g_long.pdf}
  \caption[Signal curves for creation of the static map]{Signal curves for creation of the static map for $60\,\%$ water, $40\,\%$ glycerin solution with $15 \, cm$ long tubes. Top: differential pressure, middle: rotational speed, bottom: flow through VAD.}
  \label{fig:test_60w40g_long}
\end{figure}
To determine the static map, flow data is first broken down into individual parts corresponding to the various differential pressure levels.  These are then split into data sections for each velocity rate. Finally, the mean of the last quarter of each section is calculated. The average flow values are then displayed as a function of differential pressure. The values of equal velocity levels are connected with each other.
\\At the beginning of the practical work, the Sputnik VAD was connected to the test stand via tubes of about $30\, cm$ length on both sides. Since in clinical use, the pump is implemented in the patient's body and connected to the left ventricle and aorta, the tube length is not representative of a real application. To test the effect tube length has on the operating range of the pump, three different tube lengths for attachment of the VAD to the test rig are compared. The measurements are performed with tubes of approximately $5\, cm$, $10\, cm$ and $15\, cm$ length. \figurename~\ref{fig:60w_40g} depicts the static maps for all three tube lengths measured with a fluid solution of $60\, \%$ water $40\, \%$ glycerin.
\begin{figure}[ht]
  \centering
  \includegraphics[width=\textwidth]{images/chapt_4/60w40g_tube_length_new.pdf}
  \caption[Static map for different tube length in 60 \% water 40 \% glycerin solution]{Static map for varying tube length in 60 \% water 40 \% glycerin solution.}
  \label{fig:60w_40g}
\end{figure}
\\Under inspection of the blue curves corresponding to a tube length of $5\, cm$ it is evident that measurements in this case were only performed up to a differential pressure of $\Delta{p}=100 \, mmHg$. This is a result of the abrupt change in differential pressure and reference speed which lead to spontaneous reduction of the flow and possibly high backflow values through the pump. As a result, the pump's rotor comes to a stop. For longer tubes ($10\, cm$ and $15\, cm$ length) and therefore, higher flow resistance, this phenomenon occurs at a differential pressure $\Delta{p}=140\, mmHg$. However, the deviation of the curves is insignificant when comparing all three cases. Due to this the tubes of $15\, cm$ length were chosen for reasons of improved handling of the MCL.
\\In addition to different tube lengths, another preliminary investigation is carried out with regard to the influence of the test liquid used. Since blood viscosity varies between patients and also with fluid intake, knowledge on the effect a change in liquid condition has on the control performance is required. The same measurements for determining the static map are performed in pure water, a solution of $80\, \%$ water $20\, \%$ glycerin, a solution of $60\, \%$ water $40\, \%$ glycerin and a solution of $40\, \%$ water $60\, \%$ glycerin. Representing the static maps for all four solutions measured, \figurename~\ref{fig:long_tubes} discloses significant deviations between the fluids.
\begin{figure}[ht]
  \centering
  \includegraphics[width=\textwidth]{images/chapt_4/long_liquid_change_new.pdf}
  \caption[Static map for varying fluid solution with $15\,cm$ long tubes]{Static map for varying fluid solutions with $15\,cm$ long tubes.}
  \label{fig:long_tubes}
\end{figure}
 \\Since resistance of the liquid falls with decreasing proportion of glycerin in the solution, differences in reachable differential pressure occur due to the aforementioned reason of spontaneous increase in backflow. However, as fluid resistance increases, pumpable flow decreases. All further measurements of this thesis are performed for a solution of $60\, \%$ water $40\,\%$ glycerin as this mixture most closely reflects the standard properties of blood.
\figurename~\ref{fig:anh_1} to \figurename~\ref{fig:anh_3} in the appendix show comparisons of the static maps for varying tube length in different mixing ratios of water and glycerin and \figurename~\ref{fig:anh_4} and \figurename~\ref{fig:anh_5} depict comparisons of the static maps for varying  solutions with $5\, cm$ and $10\, cm$ tube length.
The resulting static map for the chosen final setup of the MCL is depicted in \figurename~\ref{fig:60w40glong}.

\begin{figure}[ht!]
  \centering
  \includegraphics[width=\textwidth]{images/chapt_4/60w40g_long.pdf}
  \caption[Static map for solution of $60\, \%$ water $40\, \%$ glycerin with $15\,cm$ long tubes]{Static map for solution of $60\, \%$ water $40\, \%$ glycerin with $15\,cm$ long tubes.}
  \label{fig:60w40glong}
\end{figure}

%% close up von einem 1k Sprung zur Auslegung der Plant im durch 4.7 definitierten positiven Fluss Bereich.
%% Vergleich des gemessenen Signals mit simuliertem Signal.
As part of the system identification, the transfer function of the Sputnik VAD is determined. For this purpose, the step response of the pump to a $1000\,rpm$ step in reference speed is analyzed.
\\Initially, the measured flow values from the static map determination measurement are prepossessed by using a $2^{nd}$-order butterworth filter with a cut-off frequency of $f_{\mathrm{c}} = 5\,Hz$ and sampling frequency $f_{\mathrm{s}}=1000 \, Hz$. For determination of the transfer function, filtered flow for an increase from $v_{\mathrm{ref,low}}=5000\,rpm$ to $v_{\mathrm{ref,high}}=6000\,rpm$ in reference speed at a differential pressure of $\Delta{p}=40\,mmHg$ is analyzed. The blue line in \figurename~\ref{fig:plant} depicts the filtered flow for this measurement. It is evident that the system's behavior can be approximated by a $PT_1$-element.
 The characteristic parameters of the transfer function according to equation (\ref{eq:tf_pt1}) are represented in \figurename~\ref{fig:plant}. The static gain $k_{\mathrm{s}}$ is determined as
\begin{equation}
%  \begin{split}
  k_{\mathrm{s}} = \frac{k_{\mathrm{high}}-k_{\mathrm{low}}}{v_{\mathrm{ref,high}}-v_{\mathrm{ref,low}}}=0.0018
  %\\ = \frac{2.3008 - 0.4672}{6000 - 5000} = 0.0018.
%  \end{split}
\label{eq:k_s_1}
\end{equation}
with $k_{\mathrm{high}}=2.3008$ and $k_{\mathrm{low}}=0.4672$. The time constant $T$, defined as the time span between initialization of the jump and reaching $0.63 \cdot k_s$, is determinded to $T=0.081$.
According to equation (\ref{eq:tf_pt1}) the transfer function for the plant results in
\begin{equation}
    G(s) = \frac{0.0018}{1+0.081s}.
 \label{eq:plant}
\end{equation}
\begin{figure}[ht!]
  \centering
  \includegraphics[width=\textwidth]{images/chapt_4/plant_generation.pdf}
  \caption[Transfer function of Sputnik VAD]{Step in flow, triggered by a step in reference speed by $1000\,rpm$ with identification of the variables for determining the transfer function of a $PT_{\mathrm{1}}$ element.}
  \label{fig:plant}
\end{figure}
\\In order to gain knowledge on the linearity of the system the same analysis performed for differential pressure at $\Delta{p}=40\,mmHg$ is performed for various differential pressure levels increased in steps of $20\,mmHg$ starting at $\Delta{p}=0\,mmHg$ ending at $\Delta{p}=120\,mmHg$. An overview on the characteristic values $T$, $k_{\mathrm{high}}$, $k_{\mathrm{low}}$ and $k_{\mathrm{s}}$ is given in \tablename~\ref{tab:linearity}.
\begin{table}[h]
  \centering
  \begin{tabular}{c|c|c|c|c}
    \toprule
    $\Delta{p} [mmHg]$  & $T [s]$ & $k_{\mathrm{high}} [l/min]$ & $k_{\mathrm{low}} [l/min]$ & $k_{\mathrm{s}} [l/min]$\\
    \midrule
    0 & 0.139 & 6.7068 & 5.3303 & 0.0014\\
    20 & 0.104 & 2.877 & 2.0198 & 8.5786$\cdot10^{-4}$\\
    40 &  0.081 & 2.3008 & 0.4672 & 0.0018\\
    60 & 0.108 & 1.6036 & -1.303 & 0.0029\\
    80 & 0.08 & -0.9019 & -3.0695 & 0.0022\\
    100 & 0.0046 & -2.6497 & -4.2645 & 0.0016\\
    120 & 0.096 & -3.8616 & -5.5587 & 0.0017\\
    \bottomrule
  \end{tabular}
  \caption[Characteristic parameters for jumps of $1000\,rpm$ through the operating range of differential pressure.]{Characteristic parameters for jumps of $1000\,rpm$ through the operating range of differential pressure.}
\label{tab:linearity}
\end{table}
Comparing the values of the differential pressure levels with each other, it can be seen that they are close to each other with the exception of three values. Deviations such as the static gain in the range $\Delta{p}=20\,mmHg$ can be attributed at least in part to the high noise content in the signal and the filtering that is therefore necessary before determining the parameters. An assumption of linearity of the system is therefore to be regarded as admissible for the entire operating range.
